<MudTable Bordered="false"
          Dense="false"
          Filter="new Func<ThroughTheMailModel,bool>(Filter)"
          Hover="true"
          Items="@Items"
          Striped="true">
    <ToolBarContent>
        <ToolbarTitle Text="Through the Mail" />
        <MudSpacer />
        <ToolbarSearchField SearchText="@Search"
                            SearchTextChanged="@((p) => Search = p)" />
    </ToolBarContent>
    <HeaderContent>
        <TableHeader Visible="@HasCompletedItems"></TableHeader>
        <MudTh></MudTh>
        <MudTh>Person</MudTh>
        <MudTh>Sent Date</MudTh>
        <MudTh>Received Date</MudTh>
        <MudTh>Tracking Number</MudTh>
        <MudTh>SASE Tracking Number</MudTh>
        <MudTh>Status</MudTh>
        <TableHeader Visible="@HasCompletedItems">Items Received/Sent</TableHeader>
        <TableHeader Visible="@(!HasCompletedItems)">Items Sent</TableHeader>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <TableData DataLabel=""
                   Visible="@HasCompletedItems">
            <MudIconButton Icon="@context.ToggleIcon"
                           OnClick="@(_ => ToggleChildContent(@context.Id))" />
        </TableData>
        <MudTd DataLabel="">
            <GridImage ImageData="@(ImageService.GetPersonImageData(context.Person.ImageFileName))"
                       ImageLoaded="@(_ => StateHasChanged())"
                       OnClick="@(_ => ShowPersonProfile(context.Person.Id))" />
        </MudTd>
        <MudTd DataLabel="Person">@context.Person.DisplayName</MudTd>
        <MudTd DataLabel="SentDate">@(context.SentDate.HasValue ? context.SentDate.Value.ToString("MM-dd-yyyy") : string.Empty)</MudTd>
        <MudTd DataLabel="ReceivedDate">@(context.ReceivedDate.HasValue ? context.ReceivedDate.Value.ToString("MM-dd-yyyy") : string.Empty)</MudTd>
        <MudTd DataLabel="TrackingNumber">@context.TrackingNumber</MudTd>
        <MudTd DataLabel="SASETrackingNumber">@context.SelfAddressedStampedEnvelopeTrackingNumber</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
        <TableData DataLabel="ItemsReceivedSent"
                   Visible="@HasCompletedItems">@context.ItemSuccessCount</TableData>
        <TableData DataLabel="ItemsSent"
                   Visible="@(!HasCompletedItems)">@context.Memorabilia.Count()</TableData>
        <MudTd DataLabel="">
                <NavigationGridButton NavigationPath="@($"{NavigationPath.ThroughTheMail}/{Constant.EditModeType.Update.Name}/{DataProtectorService.EncryptId(context.Id)}")" />
            <DeleteGridButton ConfirmMessage="Delete TTM"
                              OnDelete="@(_ => Delete(context.Id))"
                              ShowConfirm="true" />
        </MudTd>
    </RowTemplate>
    <ChildRowContent>
        <Condition Evaluation="@context.DisplayMemorabiliaDetails">
            <Match>
                <tr />
                <tr style="background-color:#6D7B8D;color:honeydew;border-style:dashed;border-width:2px;border-color:#ECF3F4;">
                    <td align="center" colspan="17">
                         Summary: Items Sent - <strong> @context.ItemsSentCount </strong>, Items Received - <strong> @(context.Memorabilia?.Count() ?? 0) </strong>, Total Cost - <strong> @(context.TotalCost?.ToString("c") ?? "$0.00") </strong>
                    </td>
                </tr>
                <tr />
                <tr style="margin-top: 1%; margin-bottom: 1%; margin-left: 1%; margin-right: 1%;">
                    <td colspan="17">
                        <MudTable Bordered="false"
                                  Dense="false"
                                  Hover="true"
                                  Items="@(GetThroughTheMailMemorabiliaModels(context.Id))"
                                  Striped="true">
                            <ToolBarContent>
                                <ToolbarTitle Text="Memorabilia" />
                                <MudSpacer />
                            </ToolBarContent>
                            <HeaderContent>
                                <MudTh></MudTh>
                                <MudTh>Item</MudTh>
                                <MudTh>Fee/Donation</MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate Context="memorabilia">
                                    <MudTd DataLabel="">
                                        <GridImage AllowNavigation="true" 
                                                   ImageData="@(ImageService.GetUserImageData(memorabilia.PrimaryImageFileName))"
                                                   ImageLoaded="@(_ => StateHasChanged())"
                                                   OnClick="@(_ => Navigate(memorabilia.Autograph?.Id > 0
                                                                   ? $"{NavigationPath.MemorabiliaImage}/{Constant.EditModeType.Update.Name}/{DataProtectorService.EncryptId(memorabilia.Autograph.Id)}"
                                                                   : $"{NavigationPath.MemorabiliaImage}/{Constant.EditModeType.Update.Name}/{DataProtectorService.EncryptId(memorabilia.Memorabilia.Id)}"))" />
                                    </MudTd>
                                    <MudTd DataLabel="Item">@memorabilia.Memorabilia.ItemType.Name</MudTd>
                                    <MudTd DataLabel="Fee/Donation">@(memorabilia.Cost?.ToString("c") ?? string.Empty)</MudTd>
                                    <MudTd DataLabel="">
                                        @(context.ReceivedDate.HasValue && memorabilia.IsExtraReceived ? "This was an extra received." : "")
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager />
                            </PagerContent>
                        </MudTable>
                    </td>
                </tr>
            </Match>
        </Condition>
    </ChildRowContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>
