@page "/Pewters"

@using Memorabilia.Application.Features.Admin
@using Memorabilia.Application.Features.Admin.Pewter
@using System.IO

@inject CommandRouter _commandRouter
@inject NavigationManager _navigation
@inject QueryRouter _queryRouter
@inject IToastService _toastService

<_Page @ref="_page" 
       ConfirmationTitle="Delete Pewter" 
       OnConfirm="Delete" 
       OnLoad="OnLoad">
    <Content>
        <div class="row">
            <div class="col-md-12" style="text-align: center">
                <h1>@_viewModel.PageTitle</h1>
            </div>
        </div>
        <br />
        <_Table Items="_viewModel.Pewters" 
                ItemsPerPage="10"                     
                TItem="PewterViewModel">
            <HeaderTemplate>
                <th scope="col"></th>
                <th scope="col">Franchise</th>
                <th scope="col">Team</th>
                <th scope="col">Size</th>
                <th scope="col">Image Type</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </HeaderTemplate>
            <RowTemplate>
                <td>
                    <img src="data:image/jpg;base64,@Convert.ToBase64String(File.ReadAllBytes(@context.ImagePath))"
                         height="40" 
                         width="40" />                        
                </td>
                <td>@context.FranchiseName</td>
                <td>@context.TeamName</td>
                <td>@context.SizeName</td>
                <td>@context.ImageTypeName</td>
                <td>
                    <_Tooltip Text="Edit">
                        <img class="can-click" 
                             src="images/pencil.png" 
                             height="25" 
                             width="25" 
                             @onclick="@(_ => _navigation.NavigateTo($"{_viewModel.RoutePrefix}/Edit/{context.Id}"))" />
                    </_Tooltip>                        
                </td>
                <td>
                    <_Tooltip Text="Delete">
                        <img class="can-click" 
                             src="images/trash.png" 
                             height="25" 
                             width="25" 
                             @onclick="@(_ => _page.ShowConfirm(context.Id))" />
                    </_Tooltip>
                </td>
            </RowTemplate>
        </_Table>
        <div class="row">
            <div class="col-md-12" style="text-align: center">
                <div class="col-md-12" style="text-align: center">
                    <a href="Pewters/Edit">Add @_viewModel.ItemTitle</a>
                </div>
            </div>
        </div>
        <br />
    </Content>
</_Page>

@code {
    private _Page _page;
    private PewtersViewModel _viewModel;

    protected async Task Delete(int id)
    {
        var deletedItem = _viewModel.Pewters.Single(pewter => pewter.Id == id);
        var viewModel = new SavePewterViewModel(deletedItem);
        viewModel.IsDeleted = true;

        await _commandRouter.Send(new SavePewter.Command(viewModel)).ConfigureAwait(false);
        
        _viewModel.Pewters.Remove(deletedItem);

        _toastService.ShowSuccess($"{_viewModel.ItemTitle} was deleted successfully!", _viewModel.PageTitle);
    }

    protected async Task OnLoad()
    {
        _viewModel = await _queryRouter.Send(new GetPewters.Query()).ConfigureAwait(false);
    }
}
