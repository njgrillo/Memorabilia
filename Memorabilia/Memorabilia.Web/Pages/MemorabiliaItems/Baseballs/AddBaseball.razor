@page "/Memorabilia/Baseball/Add/{memorabiliaId:int}"

@using Memorabilia.Application.Features.Memorabilia
@using Memorabilia.Application.Features.Memorabilia.Baseball

@inject CommandRouter _commandRouter
@inject ProtectedLocalStorage _localStorage
@inject NavigationManager _navigation
@inject QueryRouter _queryRouter
@inject IToastService _toastService

@if (_viewModel == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-12" style="text-align: center">
            <h1>@_viewModel.PageTitle</h1>
        </div>
    </div>
    <br />
    <div style="border: 1px solid black; margin-top: 2%; margin-bottom: 2%; margin-left: 2%; margin-right: 2%;">
        <div class="row" style="margin-top: 2%; margin-bottom: 2%; margin-left: 1%; margin-right: 1%;">
            <div class="col-lg-12" style="text-align: center">
                <img src="images/itemtypes.jpg" alt="Image" height="150" width="150" />
            </div>            
            <EditForm Model="_viewModel" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <_BaseballTypes @ref="_baseballType" /> 
                <_Brands @ref="_brand" Brands="@_viewModel.Brands" />
                <_Commissioners @ref="_commissioner" Commissioners="@_viewModel.Commissioners" />
                <_Sizes @ref="_size" Sizes="@_viewModel.Sizes" /> 
                <div class="col-lg-4">
                    <label for="people">People</label>
                    <_CheckBoxList Data="@_viewModel.People"
                                   SelectedValues="@_viewModel.PersonIds"
                                   TextField="@((person)=>person.FullName)"
                                   ValueField="@((person)=>_viewModel.People.First(x => x.FullName == person.FullName).Id)" />
                </div>
                <div class="col-lg-4">
                    <label for="sports">Sports</label>
                    <_CheckBoxList Data="@_viewModel.Sports"
                                   SelectedValues="@_viewModel.SportIds"
                                   TextField="@((sport)=>sport.Name)"
                                   ValueField="@((sport)=>_viewModel.Sports.First(x => x.Name == sport.Name).Id)" />
                </div>
                <div class="col-lg-4">
                    <label for="teams">Teams</label>
                    <_CheckBoxList Data="@_viewModel.Teams"
                                   SelectedValues="@_viewModel.TeamIds"
                                   TextField="@((team)=>team.Name)"
                                   ValueField="@((team)=>_viewModel.Teams.First(x => x.Name == team.Name).Id)" />
                </div>
                <div class="text-right">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </EditForm>
        </div>
        <div class="row">
            <div class="col-md-12" style="text-align: center">
                <a href="Memorabilia/Add">Back</a>
            </div>
        </div>
        <br />
    </div>
}

@code {
    [Parameter]
    public int MemorabiliaId { get; set; }  

    private _BaseballTypes _baseballType;
    private _Brands _brand;
    private _Commissioners _commissioner;
    private _Sizes _size;
    private SaveBaseballViewModel _viewModel = new SaveBaseballViewModel();

    protected async Task HandleValidSubmit()
    {
        var userId = await _localStorage.GetAsync<int>("UserId");

        if (userId.Value == 0)
            _navigation.NavigateTo("Login");

        _viewModel.BaseballTypeId = _baseballType.BaseballTypeId;
        _viewModel.BrandId = _brand.BrandId > 0 ? _brand.BrandId : _viewModel.Brands.First().Id;
        _viewModel.CommissionerId = _commissioner.CommissionerId > 0 ? _commissioner.CommissionerId : _viewModel.Commissioners.First().Id;
        _viewModel.MemorabiliaId = MemorabiliaId;
        _viewModel.SizeId = _size.SizeId > 0 ? _size.SizeId : _viewModel.Sizes.First().Id;

        //Move    _sports to SaveBaseballViewModel
        

        // person
        // team
        // sport

        var command = new SaveBaseball.Command(_viewModel);

        await _commandRouter.Send(command).ConfigureAwait(false);

        _navigation.NavigateTo("Memorabilia");

        _toastService.ShowSuccess("Baseball Details were added successfully!", _viewModel.PageTitle);
    }

    protected override async Task OnInitializedAsync()
    {
        var userId = await _localStorage.GetAsync<int>("UserId");

        if (userId.Value == 0)
            _navigation.NavigateTo("Login");
    }
}